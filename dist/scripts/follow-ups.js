!function(){"use strict";function e(){var e=$("#follow-up-frequency");$.each(bt,function(t,o){e.append("<option value="+t+">"+o+"</option>")}),e.val("")}function t(){var e=$("#follow-up-type");$.each(wt,function(t,o){e.append("<option value="+t+">"+o+"</option>")}),e.val("3"),O()}function o(){var e=$.trim(ht.value);""===e?$().toastmessage("showErrorToast","Must enter Name"):r(e)}function n(){var e=$.trim(ht.value);""===e?$().toastmessage("showErrorToast","Must enter Name"):i(e)}function r(e){$.ajax({type:"POST",url:"ajax/create_person.php",data:{person_display:e}}).done(function(e){var t=JSON.parse(e);t.success?m(t.person_id,t.person_name):1===t.error?logout():$().toastmessage("showErrorToast","Error loading visitors")}).fail(function(){$().toastmessage("showErrorToast","Error loading visitors")})}function i(e){$.ajax({type:"GET",url:"ajax/search.php",data:{search:e}}).done(function(e){var t=JSON.parse(e);t.success?h(t.people):1===t.error?logout():$().toastmessage("showErrorToast","Error loading visitors")}).fail(function(){$().toastmessage("showErrorToast","Error loading visitors")})}function s(){$.ajax({type:"POST",url:"ajax/get_follow_ups.php",data:{date:B.value}}).done(function(e){var t=JSON.parse(e);t.success?v(t.follow_ups):1===t.error?logout():$().toastmessage("showErrorToast","Error loading visitors")}).fail(function(){$().toastmessage("showErrorToast","Error loading visitors")})}function c(e,t,o){$.ajax({type:"POST",url:"ajax/save_follow_up.php",data:{follow_up:JSON.stringify(e)}}).done(function(n){var r=JSON.parse(n);r.success?(e.id=r.follow_up_id,t.call(this,e,o),r.spouse_follow_up_id&&(e.id=r.spouse_follow_up_id,e.personId=r.spouse_id,e.name=r.spouse_name,t.call(this,e,o)),$().toastmessage("showSuccessToast","Save successful")):1===r.error?logout():r.warning?$().toastmessage("showErrorToast",r.warning):$().toastmessage("showErrorToast","Error saving follow up")}).fail(function(){$().toastmessage("showErrorToast","Error saving follow up")})}function a(e,t){$.ajax({type:"POST",url:"ajax/delete_follow_up.php",data:{id:e,personId:t}}).done(function(t){var o=JSON.parse(t);o.success?$("#follow-up-table tr[follow_up_id="+e+"]").remove():1===o.error?logout():o.warning?$().toastmessage("showErrorToast",o.warning):$().toastmessage("showErrorToast","Error deleting Follow Up")}).fail(function(){$().toastmessage("showErrorToast","Error deleting Follow Up")})}function l(e,t){if(null===e)return"";var o="";return e.first_name||e.last_name?(e.last_name&&(o+=e.last_name),e.last_name&&e.first_name?t===!0?o+=", "+e.first_name:o=e.first_name+" "+o:e.first_name&&(o+=e.first_name+" ")):o=e.description,o}function u(){J.text("Add Follow Up"),D.innerHTML="(Select a person)",D.setAttribute("personid",""),D.setAttribute("person_name",""),Y.value="3",z.value="",$("#add-to-spouse")[0].checked=!1,$("#add-to-spouse").css("display","none"),$("#add-to-spouse-label").css("display","none"),G.value="",V.checked=!1,K.checked=!1,Q.checked=!1,W.checked=!1,X.checked=!1,Z.checked=!1,et.checked=!1,tt.checked=!1,ot.checked=!1,nt.checked=!1,rt.checked=!1,it.checked=!1,lt.value="",ct.checked=!1,z.disabled=!1;for(var e=at.querySelectorAll("input"),t=0;t<e.length;t++)e[t].checked=!1;O()}function d(){var e=$.trim(D.getAttribute("person_name")),t=$.trim(D.getAttribute("personid")),o=$.trim(z.value),n=$.trim(Y.value),r=$.trim(lt.value),i={frequency:G.value,commitment_christ:!1,recommitment_christ:!1,commitment_tithe:!1,commitment_ministry:!1,commitment_baptism:!1,info_next:!1,info_gkids:!1,info_ggroups:!1,info_gteams:!1,info_member:!1,info_visit:!1,info_growth:!1},s=[],c=[],a="",l="";(""===t||0>t)&&(a+="Must select a person<br />"),""!==r||1!=n&&2!=n||(a+="Must specify comments<br />"),""!==o||ct.checked||(a+="Must specify a date or mark it unknown<br />"),r.length>5e3&&(a+="Comments cannot exceed 5000 characters<br />");for(var u=at.querySelectorAll("input"),d=0;d<u.length;d++)u[d].checked&&(s.push($.trim(u[d].nextSibling.innerHTML)),c.push(u[d].getAttribute("personid")));return 0===c.length&&(a+="Must specify a visitor<br />"),a?($().toastmessage("showErrorToast",a),!1):(3==n&&(i={frequency:G.value,commitment_christ:V.checked,recommitment_christ:K.checked,commitment_tithe:Q.checked,commitment_ministry:W.checked,commitment_baptism:X.checked,info_next:Z.checked,info_gkids:et.checked,info_ggroups:tt.checked,info_gteams:ot.checked,info_member:nt.checked,info_visit:rt.checked,info_growth:it.checked}),{id:L()?P():U.value,add_to_spouse:$("#add-to-spouse")[0].checked,date:o,name:e,personId:t,spouseId:l,typeCd:n,type:Y.selectedOptions[0].text,comments:r,communication_card_options:i,visitors:s,visitorsIds:c})}function p(e){var t=e.currentTarget.parentElement.parentElement,o=t.getAttribute("person_id"),n="true"==t.getAttribute("has_spouse").toLowerCase(),r=t.children[0].getAttribute("person_name");m(o,r,n)}function m(e,t,o){x(),D.innerHTML='<a class="person_name" href="manage-person.php?id='+e+'">'+t+"</a>",D.setAttribute("personid",e),D.setAttribute("person_name",t),$("#add-to-spouse").css("display",o?"":"none"),$("#add-to-spouse-label").css("display",o?"":"none"),$("#add-to-spouse").prop("checked",o)}function f(e){var t=e.currentTarget.parentElement.parentElement,o=t.getAttribute("person_id");window.location="manage-person.php?id="+o}function h(e){$("a.person_name").off("click",p),$("button.search-button").off("click",f),$("#search-table tbody tr").remove();for(var t=0;t<e.length;t++)_(e[t]);$("a.person_name").on("click",p),$("button.search-button").on("click",f)}function _(e){var t=l(e);$("#search-table > tbody:last").append('<tr person_id="'+e.id+'" has_spouse="'+!!parseInt(e.has_spouse)+'"><td data-th="Name" person_name="'+t+'"><a class="person_name" href="javascript:void(0);">'+t+'</a></td><td data-th="Address">'+y(e)+'</td><td data-th="" class="search-table-button-col"><button class="search-button btn btn-xs btn-info">Manage</button></td></tr>')}function y(e){var t="";return t+=e.street1||"",e.street1&&(t+="<br />"),t+=e.street2||"",e.street2&&(t+="<br />"),t+=e.city||"",e.city&&e.state&&(t+=","),t+=" ",t+=e.state||"",t+=" ",t+=e.zip||"",t.trim()}function v(e){N(),$("#follow-up-table tbody tr").remove();for(var t=0;t<e.length;t++)g(e[t]);H()}function g(e){!e.type&&e.typeCd&&(e.type=wt[e.typeCd]||""),e.date=e.date||"",e.name=e.name||"";var t,o=e.name;e.personId>=0&&(t='<a class="person_name" href="manage-person.php?id='+e.personId+'">'+o+"</a>");var n=[];for(var r in e.communication_card_options)e.communication_card_options.hasOwnProperty(r)&&e.communication_card_options[r]===!0&&n.push(r);$("#follow-up-table > tbody:last").append('<tr class="'+("1"==e.communication_card_options.frequency?"first-time-visitor":"")+'" follow_up_id="'+e.id+'" communication_card_options="'+n.join(",")+'" frequency="'+e.communication_card_options.frequency+'"><td data-th="Name" personid="'+e.personId+'" person_name="'+o+'">'+t+'</td><td data-th="Type" typeCd="'+e.typeCd+'">'+e.type+'</td><td data-th="Date" class="follow-up-table-date-col">'+e.date+'</td><td data-th="By" visitorsIds="'+e.visitorsIds.join(",")+'">'+e.visitors.join(", ")+'</td><td data-th="Comments" class="follow-up-table-comments-col">'+e.comments+'</td><td data-th="" class="follow-up-table-button-col"><button class="edit-follow-up btn btn-xs btn-default"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></button><button class="delete-follow-up btn btn-xs btn-default"><span class="glyphicon glyphicon-minus-sign" aria-hidden="true"></span></button></td></tr>')}function w(e){var t=$("#follow-up-table tr[follow_up_id="+e.id+"]"),o=t.children(),n=[];t[0].setAttribute("class","1"==e.communication_card_options.frequency?"first-time-visitor":"");for(var r in e.communication_card_options)e.communication_card_options.hasOwnProperty(r)&&e.communication_card_options[r]===!0&&n.push(r);t[0].setAttribute("frequency",e.communication_card_options.frequency),t[0].setAttribute("communication_card_options",n.join(",")),o[0].setAttribute("personid",e.personId),o[0].setAttribute("person_name",e.name),o[0].innerHTML='<a class="person_name" href="manage-person.php?id='+e.personId+'">'+e.name+"</a>",o[1].setAttribute("typeCd",e.typeCd),o[1].innerHTML=e.type,o[2].innerHTML=e.date,o[3].innerHTML=e.visitors.join(", "),o[4].setAttribute("visitorsIds",e.visitorsIds.join(",")),o[4].innerHTML=e.comments}function b(){if(""===at.innerHTML.trim())for(var e,t=0;t<visitors.length;t++)e=visitors[t],at.innerHTML+='<div class="check-field"><input type="checkbox" personid="'+e.id+'" id="follow-up-by-'+e.id+'"/><label for="follow-up-by-'+e.id+'">'+l(e)+"</label></div>"}function k(e,t){g(e),$("button.edit-follow-up:last").on("click",T),$("button.delete-follow-up:last").on("click",I),t===!0&&u()}function S(e,t){w(e),t===!0&&u()}function E(){var e=d();return e===!1?!1:(c(e,L()?k:S,!1),void 0)}function q(){var e=d();return e===!1?!1:(c(e,L()?k:S,!0),void 0)}function T(e){var t,o=e.currentTarget.parentElement.parentElement,n=o.children[2].innerHTML||"",r=(o.getAttribute("communication_card_options")||"").split(","),i={commitment_christ:!1,recommitment_christ:!1,commitment_tithe:!1,commitment_ministry:!1,commitment_baptism:!1,info_next:!1,info_gkids:!1,info_ggroups:!1,info_gteams:!1,info_member:!1,info_visit:!1};for(t=0;t<r.length;t++)i[r[t]]=!0;$("#add-to-spouse").css("display","none"),$("#add-to-spouse-label").css("display","none"),D.setAttribute("personid",o.children[0].getAttribute("personid")||""),D.setAttribute("person_name",o.children[0].getAttribute("person_name")||""),D.innerHTML=o.children[0].innerHTML||"",Y.value=o.children[1].getAttribute("typeCd")||"",z.value=n,G.value=o.getAttribute("frequency")||"",V.checked=i.commitment_christ,K.checked=i.recommitment_christ,Q.checked=i.commitment_tithe,W.checked=i.commitment_ministry,X.checked=i.commitment_baptism,Z.checked=i.info_next,et.checked=i.info_gkids,tt.checked=i.info_ggroups,ot.checked=i.info_gteams,nt.checked=i.info_member,rt.checked=i.info_visit,it.checked=i.info_growth,lt.value=o.children[4].innerHTML||"",U.value=o.getAttribute("follow_up_id"),ct.checked=""===n,z.disabled=ct.checked;var s=o.children[3].getAttribute("visitorsIds")||"",c=s.split(","),a=at.querySelectorAll("input");for(t=0;t<a.length;t++)a[t].checked=c.indexOf(a[t].getAttribute("personid"))>=0;O(),J.text("Edit Follow Up");var l=$(".follow-ups-form").offset().top;$("body").animate({scrollTop:l},200),$(".follow-ups-form").effect("highlight",{},1200)}function A(){yt.dialog("open")}function x(){yt.dialog("close")}function L(){return-1===J.text().indexOf("Edit")}function M(e){F||confirm("If you continue you will lose any unsaved changes. Continue?")||e.preventDefault()}function C(){confirm("If you continue you will lose any unsaved changes. Continue?")&&u()}function I(e){if(confirm("Are you sure you would like to PERMANENTLY delete this Follow Up?")){var t=e.currentTarget.parentElement.parentElement,o=t.getAttribute("follow_up_id"),n=t.children[0].getAttribute("personid");a(o,n)}}function j(e){z.disabled=e.target.checked,z.value=""}function O(){$("#follow-up-frequency-container").css("display",3==Y.value?"inherit":"none"),R.style.display=3==Y.value?"inherit":"none"}function H(){$("#attendance-nav").on("click",M),$("#reports-nav").on("click",M),$("button.edit-follow-up").on("click",T),$("button.delete-follow-up").on("click",I)}function N(){$("#attendance-nav").off("click",M),$("#reports-nav").off("click",M),$("button.edit-follow-up").off("click",T),$("button.delete-follow-up").off("click",I)}function P(){return--gt}$("#follow-up-date").datepicker(),$("#follow-ups-for-date").datepicker({dateFormat:"m/d/yy"}),$("#follow-ups-for-date").datepicker("setDate",new Date);var F=!0,J=$("#follow-ups-form-title"),U=document.querySelector("#follow-up-id"),D=document.querySelector("#follow-up-person"),Y=document.querySelector("#follow-up-type"),z=document.querySelector("#follow-up-date"),B=document.querySelector("#follow-ups-for-date"),G=document.querySelector("#follow-up-frequency"),R=document.querySelector(".communication-card-options"),V=document.querySelector("#follow-up-commitment-christ"),K=document.querySelector("#follow-up-recommitment-christ"),Q=document.querySelector("#follow-up-commitment-tithe"),W=document.querySelector("#follow-up-commitment-ministry"),X=document.querySelector("#follow-up-commitment-baptism"),Z=document.querySelector("#follow-up-info-next"),et=document.querySelector("#follow-up-info-gkids"),tt=document.querySelector("#follow-up-info-ggroups"),ot=document.querySelector("#follow-up-info-gteams"),nt=document.querySelector("#follow-up-info-member"),rt=document.querySelector("#follow-up-info-visit"),it=document.querySelector("#follow-up-info-growth"),st=document.querySelector("#get-follow-ups"),ct=document.querySelector("#unknown-date"),at=document.querySelector("#follow-up-visitors"),lt=document.querySelector("#follow-up-comments"),ut=document.querySelector("#add-clear"),dt=document.querySelector("#add-copy"),pt=document.querySelector("#clear"),mt=document.querySelector("#add-new-person"),ft=document.querySelector("#search"),ht=document.querySelector("#search-name"),_t=document.querySelector("#close"),yt=$("#search-form").dialog({autoOpen:!1,height:400,width:350,modal:!0,open:function(){$("body").css({overflow:"hidden"})},beforeClose:function(){$("body").css({overflow:"inherit"})}}),vt=document.querySelector("#select-person-btn"),gt=-1,wt={1:"Phone Call",2:"Visit",3:"Communication Card",4:"Entered in The City",5:"Thank You Card Sent"},bt={1:"1st Time",2:"2nd Time",3:"Often",4:"Member","":"--None Provided--"};dt.addEventListener("click",E),ut.addEventListener("click",q),pt.addEventListener("click",C),vt.addEventListener("click",A),mt.addEventListener("click",o),ft.addEventListener("click",n),ht.addEventListener("keydown",function(e){13==e.keyCode&&n()}),_t.addEventListener("click",x),st.addEventListener("click",s),$("#unknown-date").on("change",j),$("#follow-up-type").on("change",O),u(),b(),t(),e(),v(followUps)}();