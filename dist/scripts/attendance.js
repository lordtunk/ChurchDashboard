!function(){"use strict";function e(){window.location="ajax/export_attendance.php"}function t(){var e=$("#service-label-1"),t=$("#service-label-2");$.each(St.service_labels,function(n,a){e.append('<option value="'+n+'">'+a+"</option>"),t.append('<option value="'+n+'">'+a+"</option>")}),t.append('<option value="">--None--</option>'),e.val(St.default_first_service_label),t.val(St.default_second_service_label),e=$("#campus"),$.each(St.campuses,function(t,n){e.append('<option value="'+t+'">'+n+"</option>")}),e.val(St.default_campus)}function n(){try{b()&&($(".attendance-form").mask("Loading..."),setTimeout(a,50))}catch(e){$(".attendance-form").unmask()}}function a(){var e,t,n,a,o,r,c,s,i=[];for(t=$("#attendance-table > tbody:last").children(),e=0;e<t.length;e++)if(null!==t[e].getAttribute("modified")){if(n=t[e].getAttribute("personId"),o=t[e].querySelector("[name=name_description]"),r=q(n),c=M(n),o){if(a=$.trim(o.value),""===a)continue}else a=void 0;-1===n.indexOf("-")&&(s=D(n),s&&(s.first=r,s.second=c)),i.push({id:n,adult:wt,display:a,attendanceDate:B,first:r,second:c})}i.length>0||ut!=pt||ft!=_t?E(i):($(".attendance-form").unmask(),$().toastmessage("showWarningToast","No attendance was modified"))}function o(){($t||confirm("Clear out any unsaved changes?"))&&r()}function r(){c(),f(ht)}function c(){$t=!0,$("#attendance-table > tbody:last").children().remove()}function s(){st.blur(),$t=!1;var e={id:N(),adult:!0},t=_(e,B);$("#attendance-table > tbody:last").append(t),$("[personid="+e.id+"] input:checkbox").on("change",m),$("#attendance-table-container").animate({scrollTop:$("#attendance-table-container")[0].scrollHeight},kt),$(".attendance-table-attendance-col[service=second]").css("display",ot?"":"none")}function i(e){if(!e){var t=new Date,n=t.getDate()-t.getDay();e=new Date(t.setDate(n))}$("#attendance-date").datepicker("setDate",e),B=K.value,V=e,it.innerHTML=d(e)}function d(e){return Tt[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()}function l(){if($t||confirm("If you change the date you will lose any unsaved changes. Continue?")){if(et.value==tt.value)return $().toastmessage("showErrorToast","First and Second Service cannot be the same"),void 0;V=new Date(K.value),B=K.value,c(),x(!1)}else $("#attendance-date").datepicker("setDate",V);it.innerHTML=d($("#attendance-date").datepicker("getDate"))}function u(e){var t="#attendance-table-container",n=$(t),a=-1==e.target.id.indexOf("top")?n[0].scrollHeight:0;n.stop().animate({scrollTop:a},kt,"swing",function(){$("<style></style>").appendTo($(document.body)).remove()})}function f(e){J(),C(),$(".attendance-table-attendance-col input:checkbox").off("change"),T(),ht=e;for(var t=B,n="",a=0;a<ht.length;a++)ht[a].active==U.checked&&(n+=p(ht[a],t));S(xt),$("#attendance-table > tbody:last").append(n),$(".attendance-table-attendance-col input:checkbox").on("change",m),O()}function p(e){F(e.id,e.last_name,e.adult);var t=e.first?"checked":"",n=e.second?"checked":"",a="",o="";return a='<a class="person_name" href="manage-person.html?id='+e.id+'">'+e.display+"</a>",ot&&(Lt=j(),o='<td class="attendance-table-attendance-col" service="second" data-th="Second?"><label for="'+Lt+'"><input id="'+Lt+'" type="checkbox" '+n+"/></label></td>"),Lt=j(),'<tr adult="'+e.adult+'" personId="'+e.id+'"><td data-th="Name"><button class="attendance-history-button"><span class="glyphicon glyphicon-folder-close" aria-hidden="true"></span></button>'+a+'</td><td class="attendance-table-attendance-col" service="first" data-th="First?"><label for="'+Lt+'"><input id="'+Lt+'" type="checkbox" '+t+"/></label></td>"+o+"</tr>"}function _(e){var t="";return ot&&(Lt=j(),t='<td class="attendance-table-attendance-col" service="second" data-th="Second?"><label for="'+Lt+'"><input id="'+Lt+'" type="checkbox" /></label></td>'),Lt=j(),'<tr adult="'+e.adult+'" personId="'+e.id+'" modified="true"><td data-th="Name"><input name="name_description" type="text" placeholder="Last, First or Description" /></td><td class="attendance-table-attendance-col" service="first" data-th="First?"><label for="'+Lt+'"><input id="'+Lt+'" type="checkbox" /></label></td>'+t+"</tr>"}function v(e){if($t=!0,e&&0!==e.length){var t,n,a,o,r,c,s=[],i=0;for($("[personid^=-]").remove(),t=0;t<e.length;t++)ht.push(e[t]),s.push(p(e[t],B));for(t=0;t<e.length;t++){for(o=e[t],r=!1,n=0;n<ht.length;n++)if(a=ht[n],i=n,-1===H(o,a)){$(s[t]).insertBefore("[personid="+a.id+"]"),ht.splice(n,0,o),r=!0;break}r===!1&&($("#attendance-table > tbody:last").append(s[t]),ht.splice(i+1,0,o)),c=$("[personid="+o.id+"]"),c.find("a.person_name").on("click",Q),c.find("input:checkbox").on("change",m)}}}function m(e){var t=e.target,n=t.parentElement.parentElement.parentElement.getAttribute("personId"),a="first"===t.parentElement.parentElement.getAttribute("service"),o=(wt?"adult":"kid")+"_total_count",r=(wt?"adult":"kid")+"_"+(a?"first":"second")+"_count",c=ot?a?M:q:function(){return!1};$t=!1,t.parentElement.parentElement.parentElement.setAttribute("modified",!0),t.checked?(xt[r]++,c(n)||xt[o]++):(xt[r]--,c(n)||xt[o]--),h()}function h(){wt?(Et.adult_first_count.innerHTML=xt.adult_first_count+ut,Et.adult_second_count.innerHTML=xt.adult_second_count+ft,Et.adult_total_count.innerHTML=xt.adult_total_count+ut+ft,Et.kid_first_count.innerHTML=xt.kid_first_count+vt,Et.kid_second_count.innerHTML=xt.kid_second_count+mt,Et.kid_total_count.innerHTML=xt.kid_total_count+vt+mt):(Et.adult_first_count.innerHTML=xt.adult_first_count+vt,Et.adult_second_count.innerHTML=xt.adult_second_count+mt,Et.adult_total_count.innerHTML=xt.adult_total_count+vt+mt,Et.kid_first_count.innerHTML=xt.kid_first_count+ut,Et.kid_second_count.innerHTML=xt.kid_second_count+ft,Et.kid_total_count.innerHTML=xt.kid_total_count+ut+ft),xt.total_first_count=xt.adult_first_count+xt.kid_first_count,xt.total_second_count=xt.adult_second_count+xt.kid_second_count,xt.total_total_count=xt.adult_total_count+xt.kid_total_count,Et.total_first_count.innerHTML=xt.total_first_count+ut+vt,Et.total_second_count.innerHTML=xt.total_second_count+ft+mt,Et.total_total_count.innerHTML=xt.total_total_count+ut+ft+vt+mt}function b(){var e=parseInt(dt.value||0),t=parseInt(lt.value||0),n="";return(isNaN(e)||isNaN(t))&&(n+="Visitor count must be a number"),(0>e||0>t)&&(n+="Number of visitors cannot be negative"),n?($().toastmessage("showErrorToast",n),!1):(ut=e,ft=t,h(),!0)}function y(e){$("#person-attendance-history-table > tbody:last").children().remove(),gt.dialog("open"),gt[0].querySelector("#person-name").innerHTML=I(e,!1);for(var t="",n=0;n<e.attendance.length;n++)t+=k(e.attendance[n]);$("#person-attendance-history-table > tbody:last").append(t)}function k(e){var t=e.first?"checked":"",n="";return ot&&(n='<td class="attendance-table-attendance-col" service="second" data-th="Second?"><input type="checkbox" '+(e.second?"checked":"")+" disabled/></td>"),'<tr><td data-th="Date">'+e.date+'</td><td class="attendance-table-attendance-col" service="first" data-th="First?"><input type="checkbox" '+t+" disabled/></td>"+n+"</tr>"}function g(){for(var e in xt)xt.hasOwnProperty(e)&&(xt[e]=parseInt(xt[e]))}function T(){dt.value=ut=pt,lt.value=ft=_t,xt=jQuery.extend({},G);for(var e in xt)xt.hasOwnProperty(e)&&(Et[e].innerHTML=xt[e]);b()}function S(e){xt.total_first_count=xt.adult_first_count+xt.kid_first_count,xt.total_second_count=xt.adult_second_count+xt.kid_second_count,xt.total_total_count=xt.adult_total_count+xt.kid_total_count;for(var t in e)e.hasOwnProperty(t)&&(xt[t]=e[t],Et[t].innerHTML=e[t])}function L(e){$(".attendance-form").mask("Loading..."),$.ajax({type:"GET",url:"ajax/get_person_attendance.php",data:{campus:rt,label1:at,label2:ot,id:e}}).done(function(e){$(".attendance-form").unmask();var t=JSON.parse(e);t.success?(y(t.person),ot?$(".attendance-table-attendance-col[service=second]").css("display",""):$(".attendance-table-attendance-col[service=second]").css("display","none")):1===t.error?logout():$().toastmessage("showErrorToast","Error loading person's attendance history")}).fail(function(){$(".attendance-form").unmask(),$().toastmessage("showErrorToast","Error loading person's attendance history")})}function w(){$(".attendance-form").mask("Loading..."),$.ajax({type:"POST",url:"ajax/get_service_options.php"}).done(function(e){var n=JSON.parse(e);n.success&&n.options?(St=n.options,t(),x()):1===n.error?logout():$().toastmessage("showErrorToast","Error loading settings")}).fail(function(){$(".attendance-form").unmask(),$().toastmessage("showErrorToast","Error loading settings")})}function x(e){"undefined"==typeof e&&(e=!0),e||$(".attendance-form").mask("Loading..."),$.ajax({type:"POST",url:"ajax/get_attendance.php",data:{date:K.value,active:U.checked,adult:Y.checked,campus:nt.value,label1:et.value,label2:tt.value,isDefaultLoad:e}}).done(function(e){var t=JSON.parse(e);if(t.success){if(_t=0,mt=0,t.attendance_dt&&i(new Date(t.attendance_dt)),"undefined"!=typeof t.attendance_adults){var n="true"==t.attendance_adults;Y.checked=n,z.checked=!n}if("undefined"!=typeof t.attendance_active){var a="true"==t.attendance_active;U.checked=a,W.checked=!a}"undefined"!=typeof t.campus&&(nt.value=t.campus),"undefined"!=typeof t.label1&&(et.value=t.label1),"undefined"!=typeof t.label2&&(tt.value=t.label2),wt=Y.checked,rt=nt.value,at=et.value,ot=tt.value;var o=$("#service-label-2").val();wt?(pt=ut=parseInt(t.visitors1.adult_visitors),vt=parseInt(t.visitors1.kid_visitors),o&&(_t=ft=parseInt(t.visitors2.adult_visitors),mt=parseInt(t.visitors2.kid_visitors))):(pt=ut=parseInt(t.visitors1.kid_visitors),vt=parseInt(t.visitors1.adult_visitors),o&&(_t=ft=parseInt(t.visitors2.kid_visitors),mt=parseInt(t.visitors2.adult_visitors))),xt=t.totals,g(),G=jQuery.extend({},xt),f(t.people),b(),$("#name-table-header").text(wt?"Adults":"Kids");var r=St.service_labels[$("#service-label-1").val()];if($(".first-service-header").text(r),$("#first-service-total-header").text(r+" Attendance"),$("#visitors-first-service-label").text(r+" Visitors"),o?($(".second-service-header").text(St.service_labels[o]),$("#second-service-total-header").text(St.service_labels[o]+" Attendance"),$(".second-service-header").css("display",""),$("#first-service-total-row").css("display",""),$("#second-service-total-row").css("display",""),$(".attendance-table-attendance-col[service=second]").css("display",""),$("#visitors-second-service-label").css("display","").text(St.service_labels[o]+" Visitors"),$("#visitors-second-service").css("display","")):($(".second-service-header").css("display","none"),$("#first-service-total-row").css("display","none"),$("#second-service-total-row").css("display","none"),$(".attendance-table-attendance-col[service=second]").css("display","none"),$("#visitors-second-service-label").css("display","none"),$("#visitors-second-service").css("display","none")),$(".campus-text").text(St.campuses[$("#campus").val()]),t.scroll_to_id&&t.scroll_to_id>=0){var c=$("[personid="+t.scroll_to_id+"]")[0];if(c){var s="#attendance-table-container",d=$(s).offset().top,l=c.offsetTop;$("body").animate({scrollTop:d},300),$(s).animate({scrollTop:l},kt)}}$(".attendance-form").unmask()}else $(".attendance-form").unmask(),1===t.error?logout():$().toastmessage("showErrorToast","Error loading")}).fail(function(){$(".attendance-form").unmask(),$().toastmessage("showErrorToast","Error loading")})}function E(e){$.ajax({type:"POST",url:"ajax/save_people.php",data:{people:JSON.stringify(e),campus:rt,label1:at,label2:ot,visitors1:ut,visitors2:ft,adult:wt,date:B}}).done(function(e){$(".attendance-form").unmask();var t=JSON.parse(e);t.success?(G=jQuery.extend({},xt),v(t.people),$(".attendance-table-attendance-col[service=second]").css("display",ot?"":"none"),$().toastmessage("showSuccessToast","Save successful")):1===t.error?logout():$().toastmessage("showErrorToast","Error saving")})}function q(e){return $("[personId="+e+"] input:checkbox:first")[0].checked}function M(e){return $("[personId="+e+"] input:checkbox:last")[0].checked}function H(e,t){if(e==t)return 0;if(null===e)return-1;if(null===t)return 1;var n=I(e,!0),a=I(t,!0);if(e.first_name||e.last_name){if(!t.first_name&&!t.last_name)return-1;if(n==a)return 0;if(n.toLowerCase()<a.toLowerCase())return-1;if(n.toLowerCase()>a.toLowerCase())return 1}else{if(t.first_name||t.last_name)return 1;if(n==a)return 0;if(n.toLowerCase()<a.toLowerCase())return-1;if(n.toLowerCase()>a.toLowerCase())return 1}}function I(e,t){if(null===e)return"";var n="";return e.first_name||e.last_name?(e.last_name&&(n+=e.last_name),e.last_name&&e.first_name?t===!0?n+=", "+e.first_name:n=e.first_name+" "+n:e.first_name&&(n+=e.first_name+" ")):n=e.description,n}function D(e){for(var t=0;t<ht.length;t++)if(ht[t].id===e)return ht[t];return null}function j(){return"id-"+ ++bt}function N(){return--yt}function O(){$("#attendance-nav").on("click",Q),$("#reports-nav").on("click",Q),$("a.person_name").on("click",Q),$("button.attendance-history-button").on("click",A)}function C(){$("#attendance-nav").off("click",Q),$("#reports-nav").off("click",Q),$("a.person_name").off("click",Q),$("button.attendance-history-button").off("click",A)}function A(){var e=this.parentElement.parentElement.getAttribute("personId");L(e)}function J(){document.querySelector("#jump-to").innerHTML="<option>--Jump To Letter--</option>"}function F(e,t){if(t){var n=t.substr(0,1).toUpperCase();if(!($('#jump-to option:contains("'+n+'")').length>0)){var a=document.querySelector("#jump-to"),o=document.createElement("option");o.setAttribute("scroll_to_id",e),o.innerHTML=n,a.appendChild(o)}}}function P(e){var t=e.target.options[e.target.options.selectedIndex];if(t){var n=$("[personid="+t.getAttribute("scroll_to_id")+"]")[0];if(n){var a="#attendance-table-container",o=$(a).offset().top,r=n.offsetTop;$("body").animate({scrollTop:o},300),$(a).animate({scrollTop:r},kt)}}}function Q(e){$t||confirm("If you continue you will lose any unsaved changes. Continue?")||e.preventDefault()}$("#attendance-date").datepicker({dateFormat:"m/d/yy"});var V,B,G,K=document.querySelector("#attendance-date"),U=document.querySelector("#active-true"),W=document.querySelector("#active-false"),Y=document.querySelector("#adults-true"),z=document.querySelector("#adults-false"),R=document.querySelector("#update"),X=document.querySelector("#cancel"),Z=document.querySelector("#export"),et=document.querySelector("#service-label-1"),tt=document.querySelector("#service-label-2"),nt=document.querySelector("#campus"),at=-1,ot=-1,rt=-1,ct=document.querySelector("#go-arrow"),st=document.querySelector("#add-person"),it=document.querySelector("#attendance-date-display"),dt=document.querySelector("#visitors-first-service"),lt=document.querySelector("#visitors-second-service"),ut=0,ft=0,pt=0,_t=0,vt=0,mt=0,ht=[],bt=0,yt=-1,$t=!0,kt=1e3,gt=$(".dialog-form").dialog({autoOpen:!1,height:420,width:350,modal:!0,open:function(){$("body").css({overflow:"hidden"})},beforeClose:function(){$("body").css({overflow:"inherit"})}}),Tt=["January","February","March","April","May","June","July","August","September","October","November","December"],St={},Lt=-1,wt=!0,xt={},Et={total_first_count:document.querySelector("#total-first-count"),total_second_count:document.querySelector("#total-second-count"),total_total_count:document.querySelector("#total-total-count"),adult_first_count:document.querySelector("#adult-first-count"),adult_second_count:document.querySelector("#adult-second-count"),adult_total_count:document.querySelector("#adult-total-count"),kid_first_count:document.querySelector("#kid-first-count"),kid_second_count:document.querySelector("#kid-second-count"),kid_total_count:document.querySelector("#kid-total-count")};i(),R.addEventListener("click",n),X.addEventListener("click",o),Z.addEventListener("click",e),ct.addEventListener("click",l),st.addEventListener("click",s),$(".jump-to").on("change",P),$(".navigation-links a").on("click",u),$("#refresh-visitors").on("click",b),checkLoginStatus(w)}();